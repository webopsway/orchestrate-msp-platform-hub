import swaggerUi from 'swagger-ui-express';

// Sp√©cification OpenAPI compl√®te
const openApiSpec = {
  openapi: '3.0.3',
  info: {
    title: 'MSP Platform API',
    description: `
# üöÄ API Backend MSP Platform

API Backend pour la plateforme MSP (Managed Service Provider) avec architecture s√©par√©e.

## üîê Authentification
L'API utilise des tokens Bearer JWT pour l'authentification. Tous les endpoints \`/api/*\` n√©cessitent une authentification sauf \`/api/auth/login\`.

### üîß Token de d√©veloppement
Pour tester l'API en d√©veloppement, utilisez le token sp√©cial : **\`dev\`**

Ce token vous donnera des privil√®ges administrateur MSP complets.

## üèóÔ∏è Architecture S√©par√©e
- **MSP Admin Interface**: Acc√®s complet aux donn√©es (port 3000)
- **Client Portal Interface**: Acc√®s filtr√© par tenant (port 3001)
- **API Backend**: Logique m√©tier centralis√©e (port 3002)

## ‚ö° Fonctionnalit√©s
- ‚úÖ Rate Limiting: 100 requ√™tes par IP toutes les 15 minutes
- ‚úÖ CORS configur√© pour localhost et \`*.msp.com\`
- ‚úÖ Authentification JWT avec tokens de d√©veloppement
- ‚úÖ Documentation interactive compl√®te
- ‚úÖ Validation des donn√©es et gestion d'erreurs
    `,
    version: '1.0.0',
    contact: {
      name: 'MSP Platform API Support',
      email: 'support@msp.com'
    },
    license: {
      name: 'Proprietary License',
      url: 'https://msp.com/license'
    }
  },
  servers: [
    {
      url: 'http://localhost:3002',
      description: 'üîß Serveur de d√©veloppement local'
    },
    {
      url: 'https://api.msp.com',
      description: 'üåê Serveur de production'
    }
  ],
  paths: {
    '/health': {
      get: {
        tags: ['üü¢ Health & Status'],
        summary: 'V√©rification de sant√© du serveur',
        description: '**Endpoint publique** pour v√©rifier que l\'API fonctionne correctement.\n\nAucune authentification requise.',
        operationId: 'healthCheck',
        responses: {
          '200': {
            description: '‚úÖ API op√©rationnelle',
            content: {
              'application/json': {
                schema: {
                  type: 'object',
                  properties: {
                    success: { type: 'boolean', example: true },
                    message: { type: 'string', example: 'API MSP Platform is running' },
                    timestamp: { type: 'string', format: 'date-time', example: '2025-01-24T01:15:30.000Z' },
                    version: { type: 'string', example: '1.0.0' },
                    environment: { type: 'string', example: 'development' },
                    uptime: { type: 'number', example: 3600.5, description: 'Temps de fonctionnement en secondes' },
                    documentation: {
                      type: 'object',
                      properties: {
                        swagger_ui: { type: 'string', example: '/api-docs' },
                        openapi_json: { type: 'string', example: '/api-docs.json' },
                        health_check: { type: 'string', example: '/health' }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    '/api': {
      get: {
        tags: ['üìö Documentation'],
        summary: 'Documentation des endpoints disponibles',
        description: '**Endpoint publique** qui retourne la liste de tous les endpoints disponibles de l\'API avec leurs descriptions.',
        operationId: 'getApiDocumentation',
        responses: {
          '200': {
            description: 'üìã Liste des endpoints',
            content: {
              'application/json': {
                schema: {
                  type: 'object',
                  properties: {
                    success: { type: 'boolean', example: true },
                    message: { type: 'string', example: 'API MSP Platform - Endpoints disponibles' },
                    version: { type: 'string', example: '1.0.0' },
                    documentation: {
                      type: 'object',
                      properties: {
                        swagger_ui: { type: 'string', example: '/api-docs' },
                        openapi_json: { type: 'string', example: '/api-docs.json' }
                      }
                    },
                    endpoints: {
                      type: 'object',
                      description: 'Structure compl√®te des endpoints disponibles'
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    '/api/users': {
      get: {
        tags: ['üë• Gestion des Utilisateurs'],
        summary: 'Liste des utilisateurs',
        description: `
### üìã R√©cup√©ration des utilisateurs selon les permissions

**Permissions :**
- **MSP Admin** : Voir tous les utilisateurs de toutes les organisations
- **Utilisateur normal** : Voir seulement les membres de son √©quipe

### üß™ Exemples de test avec curl

\`\`\`bash
# R√©cup√©rer tous les utilisateurs (MSP Admin)
curl -H "Authorization: Bearer dev" http://localhost:3002/api/users

# Filtrer par √©quipe sp√©cifique
curl -H "Authorization: Bearer dev" "http://localhost:3002/api/users?team_id=uuid-equipe"
\`\`\`

### üìä Donn√©es retourn√©es
- Informations utilisateur compl√®tes
- Organisation et √©quipe associ√©es
- M√©tadonn√©es (r√¥le, d√©partement, statut)
        `,
        operationId: 'getUsers',
        security: [{ bearerAuth: [] }],
        parameters: [
          {
            name: 'team_id',
            in: 'query',
            description: 'üéØ Filtrer par ID d\'√©quipe (optionnel)',
            schema: { type: 'string', format: 'uuid' },
            example: '789e0123-e89b-12d3-a456-426614174002'
          }
        ],
        responses: {
          '200': {
            description: '‚úÖ Liste des utilisateurs r√©cup√©r√©e',
            content: {
              'application/json': {
                schema: {
                  type: 'object',
                  properties: {
                    success: { type: 'boolean', example: true },
                    data: {
                      type: 'array',
                      items: { $ref: '#/components/schemas/User' }
                    },
                    count: { type: 'integer', example: 5, description: 'Nombre total d\'utilisateurs' }
                  }
                }
              }
            }
          },
          '401': { $ref: '#/components/responses/Unauthorized' },
          '403': { $ref: '#/components/responses/Forbidden' }
        }
      }
    }
  },
  components: {
    securitySchemes: {
      bearerAuth: {
        type: 'http',
        scheme: 'bearer',
        bearerFormat: 'JWT',
        description: `
## üîê Authentification JWT

**Format :** \`Bearer <token>\`

### üîß Token de d√©veloppement
Pour tester l'API en d√©veloppement :
\`\`\`
dev
\`\`\`

Ce token vous donnera des **privil√®ges administrateur MSP complets**.

### üîí Production
En production, obtenez un vrai token JWT via \`POST /api/auth/login\`.
        `
      }
    },
    schemas: {
      User: {
        type: 'object',
        description: 'üë§ Mod√®le complet d\'un utilisateur du syst√®me',
        properties: {
          id: {
            type: 'string',
            format: 'uuid',
            description: 'Identifiant unique de l\'utilisateur',
            example: '123e4567-e89b-12d3-a456-426614174000'
          },
          email: {
            type: 'string',
            format: 'email',
            description: 'Adresse email (unique)',
            example: 'utilisateur@exemple.com'
          },
          first_name: {
            type: 'string',
            description: 'Pr√©nom de l\'utilisateur',
            example: 'Jean'
          },
          last_name: {
            type: 'string',
            description: 'Nom de famille de l\'utilisateur',
            example: 'Dupont'
          },
          is_msp_admin: {
            type: 'boolean',
            description: 'üîê Indique si l\'utilisateur est administrateur MSP',
            example: false
          },
          created_at: {
            type: 'string',
            format: 'date-time',
            description: 'Date de cr√©ation du compte',
            example: '2025-01-24T01:15:30.000Z'
          }
        },
        required: ['id', 'email', 'first_name', 'last_name']
      }
    },
    responses: {
      Unauthorized: {
        description: 'üö´ Token manquant ou invalide',
        content: {
          'application/json': {
            schema: {
              type: 'object',
              properties: {
                success: { type: 'boolean', example: false },
                error: { type: 'string', example: 'Token d\'authentification manquant' },
                code: { type: 'string', example: 'NO_TOKEN' }
              }
            }
          }
        }
      },
      Forbidden: {
        description: 'üîí Acc√®s interdit - permissions insuffisantes',
        content: {
          'application/json': {
            schema: {
              type: 'object',
              properties: {
                success: { type: 'boolean', example: false },
                error: { type: 'string', example: 'Acc√®s non autoris√©' },
                code: { type: 'string', example: 'ACCESS_DENIED' }
              }
            }
          }
        }
      }
    }
  },
  tags: [
    {
      name: 'üü¢ Health & Status',
      description: 'Endpoints de v√©rification de sant√© et statut du serveur'
    },
    {
      name: 'üìö Documentation',
      description: 'Documentation auto-g√©n√©r√©e de l\'API avec tous les endpoints'
    },
    {
      name: 'üë• Gestion des Utilisateurs',
      description: 'CRUD complet pour la gestion des utilisateurs MSP et clients avec permissions granulaires'
    }
  ]
};

// Configuration Swagger UI optimis√©e pour CORRIGER les erreurs SSL
const swaggerOptions = {
  customCss: `
    .swagger-ui .topbar { display: none; }
    .swagger-ui .info {
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
    }
    .swagger-ui .info .title {
      color: white !important;
      font-size: 42px;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .swagger-ui .info .description {
      color: white !important;
      font-size: 14px;
      line-height: 1.8;
      opacity: 0.95;
    }
    .swagger-ui .scheme-container {
      background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
      color: #2d3436;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 25px;
      border: none;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    .swagger-ui .auth-wrapper {
      margin-bottom: 25px;
    }
    .swagger-ui .btn.authorize {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      border-radius: 8px;
      padding: 12px 24px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    .swagger-ui .btn.authorize:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    .swagger-ui .opblock {
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border: none;
      overflow: hidden;
    }
    .swagger-ui .opblock-summary {
      border-radius: 12px 12px 0 0;
      padding: 15px 20px;
    }
    .swagger-ui .opblock.opblock-get .opblock-summary {
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
    }
    .swagger-ui .opblock.opblock-post .opblock-summary {
      background: linear-gradient(135deg, #0984e3 0%, #74b9ff 100%);
    }
    .swagger-ui .opblock.opblock-put .opblock-summary {
      background: linear-gradient(135deg, #fdcb6e 0%, #f39c12 100%);
    }
    .swagger-ui .opblock.opblock-delete .opblock-summary {
      background: linear-gradient(135deg, #e84393 0%, #fd79a8 100%);
    }
    .swagger-ui .response-col_status {
      font-weight: bold;
    }
    .swagger-ui .model-box {
      border-radius: 8px;
      background: #f8fafc;
    }
    .swagger-ui .parameter__name {
      font-weight: 600;
    }
    .swagger-ui .response-col_description {
      font-weight: 500;
    }
  `,
  customSiteTitle: 'üöÄ MSP Platform API - Documentation Interactive',
  customfavIcon: '/favicon.ico',
  swaggerOptions: {
    // CORRECTION SSL: Configuration explicite pour HTTP local
    url: 'http://localhost:3002/api-docs.json',
    validatorUrl: null, // D√©sactiver la validation externe qui peut causer des erreurs SSL
    defaultModelsExpandDepth: 3,
    defaultModelExpandDepth: 3,
    docExpansion: 'list',
    filter: true,
    showRequestHeaders: true,
    tryItOutEnabled: true,
    persistAuthorization: true,
    displayOperationId: false,
    displayRequestDuration: true,
    deepLinking: true,
    showExtensions: true,
    showCommonExtensions: true,
    // Forcer l'utilisation de HTTP pour toutes les requ√™tes
    requestInterceptor: (request) => {
      // S'assurer que toutes les requ√™tes utilisent HTTP
      if (request.url && request.url.startsWith('https://localhost')) {
        request.url = request.url.replace('https://localhost', 'http://localhost');
      }

      // Auto-ajouter le token dev en d√©veloppement si aucun token n'est pr√©sent
      if (process.env.NODE_ENV === 'development' && !request.headers.Authorization) {
        request.headers.Authorization = 'Bearer dev';
        console.log('üîß Token de d√©veloppement ajout√© automatiquement');
      }
      return request;
    },
    // Intercepter les r√©ponses pour debug
    responseInterceptor: (response) => {
      console.log('üì° R√©ponse Swagger:', response.status, response.url);
      return response;
    }
  }
};

/**
 * Configuration Swagger optimis√©e pour corriger les erreurs SSL en d√©veloppement local
 */
export const setupSwagger = (app) => {
  // Middleware CORS global pour toutes les routes Swagger
  app.use('/api-docs*', (req, res, next) => {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With');
    res.setHeader('Access-Control-Allow-Credentials', 'false');

    // Forcer HTTP et d√©sactiver les headers s√©curis√©s qui causent des probl√®mes
    res.setHeader('X-Content-Type-Options', 'nosniff');
    res.setHeader('Referrer-Policy', 'no-referrer');

    if (req.method === 'OPTIONS') {
      return res.status(200).end();
    }
    next();
  });

  // Route pour la sp√©cification OpenAPI (JSON) - CORRECTION SSL
  app.get('/api-docs.json', (req, res) => {
    res.setHeader('Content-Type', 'application/json');
    res.setHeader('Cache-Control', 'no-cache, no-store, must-revalidate');
    res.setHeader('Pragma', 'no-cache');
    res.setHeader('Expires', '0');

    // Modifier la sp√©cification pour forcer HTTP en d√©veloppement
    const spec = { ...openApiSpec };
    if (process.env.NODE_ENV === 'development') {
      spec.servers = [
        { url: 'http://localhost:3002', description: 'üîß Serveur de d√©veloppement local (HTTP)' }
      ];
    }

    res.json(spec);
  });

  // Interface Swagger UI avec configuration locale anti-SSL
  app.use('/api-docs', swaggerUi.serve);
  app.get('/api-docs', swaggerUi.setup(openApiSpec, {
    ...swaggerOptions,
    // Configuration suppl√©mentaire pour corriger SSL
    swaggerOptions: {
      ...swaggerOptions.swaggerOptions,
      // Forcer l'utilisation locale et d√©sactiver les validations externes
      plugins: [
        () => ({
          statePlugins: {
            spec: {
              wrapSelectors: {
                allowTryItOutFor: () => () => true
              }
            }
          }
        })
      ]
    }
  }));

  // Redirection depuis /docs vers /api-docs pour compatibilit√©
  app.get('/docs', (req, res) => {
    res.redirect('/api-docs');
  });

  console.log('üìö Documentation Swagger configur√©e avec correction SSL:');
  console.log('   üìñ Interface HTML interactive: http://localhost:3002/api-docs');
  console.log('   üìÑ Sp√©cification JSON:         http://localhost:3002/api-docs.json');
  console.log('   üîó Raccourci:                  http://localhost:3002/docs');
  console.log('   üîß Token dev auto-configur√© pour les tests');
  console.log('   ‚úÖ Configuration HTTP locale (pas de SSL)');
  console.log('   üõ°Ô∏è  CORS et validations externes d√©sactiv√©es');
};

export default { setupSwagger, openApiSpec };
